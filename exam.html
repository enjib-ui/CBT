<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam CBT</title>

  <!-- PWA meta untuk iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 80%;
  max-width: 400px;
  text-align: center;
}
.modal-content h3 { margin-bottom: 15px; }
.modal-content button {
  margin: 5px;
  padding: 8px 12px;
  border: none;
  background: #3498db;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
.modal-content button.done { background: #27ae60; }
.close {
  float: right;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
}
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background:#f9f9f9;
    }
    #examSection {
  height: calc(100vh - 60px); /* kurangi tinggi header */
  overflow-y: auto;           /* biarkan scroll kalau isi panjang */
  padding-bottom: 80px;       /* ruang untuk tombol bawah */
    }
    
    header { background:#3498db; color:white; padding:12px;
             display:flex; justify-content:space-between; align-items:center; font-size:18px; }
    header button { background:#e74c3c; border:none; padding:8px 12px; color:white; border-radius:6px; }
    .timer { font-weight:bold; }
    .container { padding:15px; }
    #question { background:white; padding:15px; border-radius:8px;
                box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:15px; }
    #opts button { width:100%; margin:5px 0; padding:12px; border:1px solid #ccc; border-radius:8px;
                   text-align:left; background:white; }
    #opts button.selected { background:#dff0ff; border-color:#3498db; }
    #navQ { display:flex; flex-wrap:wrap; gap:5px; margin-top:15px; }
    #navQ button { flex:1 0 18%; min-width:40px; padding:8px; border-radius:6px; border:none;
                   background:#3498db; color:white; }
    #navQ button.done { background:#27ae60; }
    #navButtons button {
  padding: 10px 16px;
  background: #3498db;
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
#navButtons button:disabled {
  background: #aaa;
  cursor: not-allowed;
}
    
    #submitBtn { margin-top:15px; width:100%; padding:12px; background:#27ae60; border:none;
                 border-radius:8px; color:white; font-size:16px; display:none; }
    #submitBtn:disabled { background:#aaa; }
    #startSection { text-align:center; margin-top:40px; }
    #startSection button { padding:12px 20px; font-size:16px; background:#27ae60; color:white;
                           border:none; border-radius:8px; }
    #fullscreenBtn { margin-top:10px; display:none; background:#f39c12; color:white;
                     padding:10px; border:none; border-radius:6px; width:100%; }
    #iosMsg { margin-top:10px; display:none; color:#c0392b; font-weight:bold; text-align:center; }
  </style>
</head>
<body>
  <header>
    <span>Latihan Soal</span>
    <button onclick="openNavModal()">Nomor Soal</button>
    <span class="timer" id="timer">--:--</span>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="container">
    <div id="startSection">
      <p id="startMsg">‚è≥ Menunggu jadwal ujian...</p>
      <button id="startBtn" onclick="openConfirmModal()" disabled>Mulai Ujian</button>
    </div>

    <div id="examSection" style="display:none;">
      <div id="question"></div>
      <div id="opts"></div>
      <!-- üîπ Tombol navigasi soal -->
<div id="navButtons" style="margin-top:15px; display:flex; justify-content:space-between;">
  <button id="prevBtn" onclick="prevQuestion()">‚¨ÖÔ∏è Sebelum</button>
  <button id="nextBtn" onclick="nextQuestion()">Selanjutnya ‚û°Ô∏è</button>
</div>
      <button id="submitBtn" onclick="openSubmitConfirmModal()">Kirim Jawaban</button>
      <p id="submitMsg" style="color:green;font-weight:bold"></p>
      <!-- Tombol fullscreen (Android) -->
      <button id="fullscreenBtn" onclick="startFullscreen()">‚õ∂ Kembali ke Fullscreen</button>
      <!-- Pesan khusus iOS -->
      <p id="iosMsg">üì± Untuk fullscreen di iPhone/iPad, silakan <br>‚ÄúAdd to Home Screen‚Äù dari Safari</p>
    </div>
  </div>
  <div id="navModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeNavModal()">&times;</span>
    <h3>Pilih Nomor Soal</h3>
    <div id="navQ"></div>
  </div>
  </div>
  <!-- ü™ß Modal konfirmasi sebelum mulai ujian -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>Perhatian!</h3>
    <p>
      Dengan menekan <b>"Masuk Ujian"</b>, Anda akan masuk ke mode layar penuh
      (fullscreen) dan <b>tidak diperbolehkan keluar</b> selama ujian berlangsung.
      Notifikasi akan muncul di Pengawas jika keluar dari fullscreeen.
    </p>
    <button id="confirmYes" class="done">Masuk Ujian</button>
    <button id="confirmNo">Batal</button>
  </div>
</div>
  <!-- üì® Modal konfirmasi kirim jawaban -->
<div id="submitConfirmModal" class="modal">
  <div class="modal-content">
    <h3>Konfirmasi Selesai Ujian</h3>
    <p>
      Setelah Anda menekan <b>"Kirim Jawaban"</b>, jawaban akan dikirim dan
      <b>Anda tidak dapat kembali mengakses soal</b>. Pastikan semua jawaban sudah benar.
    </p>
    <button id="submitYes" class="done">Kirim Jawaban</button>
    <button id="submitNo">Batal</button>
  </div>
</div>
  

  <!-- üîä Suara alert ketika keluar fullscreen -->
  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDonmsxOpPSafblXFwjZozjQjb6d_ONDG8",
      authDomain: "authfirebase-4a2ce.firebaseapp.com",
      projectId: "authfirebase-4a2ce",
      storageBucket: "authfirebase-4a2ce.firebasestorage.app",
      messagingSenderId: "395028121712",
      appId: "1:395028121712:web:8bf3d5470c13204bef8cb5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const alertAudioElem = document.getElementById("alertSound");
  if (alertAudioElem) {
    alertAudioElem.volume = 1.0;
  }

    let soalData = [];
    let current = 0;
    let answers = {};
    let soalStart, soalEnd, timerInterval;
    let soalFound = null;
    let soalFoundId = null;
    let soalMinSubmit = 0;
    let examStartTime = null;
    
    function shuffleArray(array) {
  let arr = array.slice(); // buat salinan biar tidak merusak data asli
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
    }

    function isiOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent); }
    function isAndroid() { return /Android/.test(navigator.userAgent); }
    window.openNavModal = function() {
  document.getElementById("navModal").style.display = "flex";
      renderNav();
}
window.closeNavModal = function() {
  document.getElementById("navModal").style.display = "none";
      }
    

    // =====================
    // Fullscreen utils
    // =====================
    window.startFullscreen = function() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    };

    document.addEventListener("fullscreenchange", () => {
      const btnFS = document.getElementById("fullscreenBtn");
      const audio = document.getElementById("alertSound");
      if (!document.fullscreenElement && isAndroid()) {
        logCheating("Keluar fullscreen");
        btnFS.style.display = "block";
      
      // üö® Getar di Android
      if (navigator.vibrate) 
        navigator.vibrate([200, 100, 200]);
      if (audio) {
  audio.playbackRate = 1.5; // bisa diubah 1.2, 2.0, dst
  let playCount = 0;
  const maxPlay = 3;
  const delay = 150; // jeda antar beep (ms)

  function playBeep() {
    if (playCount < maxPlay) {
      audio.currentTime = 0;
      audio.play().catch(()=>{}); // play bisa gagal di iOS/Android jika belum unlock
      playCount++;
      setTimeout(playBeep, delay);
    }
  }

  playBeep();
}
      } else {
    btnFS.style.display = "none";
      }
});

    // =========================
// Modal konfirmasi ujian
// =========================
const confirmModal = document.getElementById('confirmModal');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

window.openConfirmModal = function() {
  confirmModal.style.display = 'flex';
};

confirmYes.addEventListener('click', () => {
  confirmModal.style.display = 'none';
  // masuk fullscreen
  if (isAndroid()) startFullscreen();
  // lanjut ke fungsi start ujian asli
  startExam();
});

confirmNo.addEventListener('click', () => {
  confirmModal.style.display = 'none';
});
// =========================
// Modal konfirmasi submit jawaban
// =========================
const submitConfirmModal = document.getElementById('submitConfirmModal');
const submitYes = document.getElementById('submitYes');
const submitNo = document.getElementById('submitNo');

window.openSubmitConfirmModal = function() {
  submitConfirmModal.style.display = 'flex';
};

submitYes.addEventListener('click', () => {
  submitConfirmModal.style.display = 'none';
  submitExam();  // panggil fungsi pengiriman jawaban asli
});

submitNo.addEventListener('click', () => {
  submitConfirmModal.style.display = 'none';
});
    

    // =====================
    // Exam logic
    // =====================
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "index.html"; return; }
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) { logout(); return; }
      const kelasUser = userDoc.data().kelas;

      const snapshot = await getDocs(collection(db, "soal"));
      for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        if (data.aktif && docSnap.id.startsWith(kelasUser)) {
          if (data.allowedUsers && data.allowedUsers.includes(user.uid)) {
            soalFound = data;
            soalFoundId = docSnap.id;
            soalMinSubmit = soalFound.minSubmit || 0;   // ‚¨ÖÔ∏è ambil dari Firestore
            break;
          }
        }
      }

      if (!soalFound) {
        document.querySelector(".container").innerHTML =
          "<p>‚ùå Tidak ada soal aktif atau Anda tidak terdaftar untuk ujian ini.</p>";
        return;
      }

      await setDoc(doc(db, "jawaban", user.uid), {
        soalId: soalFoundId,
        present: true,
        presentAt: new Date(),
        lastActivity: new Date(),
        started: false,
        submitted: false
      }, { merge: true });

      soalData = shuffleArray(soalFound.soal.slice()); // slice() biar tidak mengubah aslinya
      const [jam, menit] = soalFound.jamMulai.split(":").map(Number);
      soalStart = new Date();
      soalStart.setHours(jam, menit, 0, 0);
      soalEnd = new Date(soalStart.getTime() + soalFound.durasi * 60000);

      // sekarang boleh cek apakah user sudah sempat mulai ujian (resume)
const jawabanDoc = await getDoc(doc(db, "jawaban", user.uid));
if (jawabanDoc.exists()) {
  const dataJawaban = jawabanDoc.data();

  // üîπ Ambil waktu mulai ujian dari Firestore (supaya timer submit sinkron)
  if (dataJawaban.startedAt) {
    if (typeof dataJawaban.startedAt.toDate === "function") {
      examStartTime = dataJawaban.startedAt.toDate();
    } else {
      examStartTime = new Date(dataJawaban.startedAt);
    }
  }

  // üîπ Ambil jawaban lama & warnai nav
  if (dataJawaban.answers) {
    answers = dataJawaban.answers;
    Object.keys(answers).forEach(idx => {
      // langsung tandai soal yang sudah dijawab
      const i = parseInt(idx);
      if (!isNaN(i)) {
        // tandai di navigator
        // renderNav() nanti tetap jalan, tapi ini memastikan warna tetap
      }
    });
  }

// üîπ Kalau ujian sudah pernah dimulai & masih dalam durasi,
// jangan langsung lompat ke soal ‚Üí tetap tunggu tombol "Mulai Ujian"
const now = new Date();
if (examStartTime && soalEnd > now) {
  // tampilkan start section lagi
  document.getElementById("startSection").style.display = "block";
  document.getElementById("examSection").style.display = "none";

  // ubah pesan supaya siswa tahu ini resume
  const msg = document.getElementById("startMsg");
  msg.innerText = "üîÑ Anda sudah mulai ujian ini, tekan tombol di bawah untuk melanjutkan.";

  // pastikan tombol bisa diklik kalau sudah masuk jadwal
  document.getElementById("startBtn").disabled = false;
} else if (soalEnd <= now) {
  document.querySelector(".container").innerHTML = "<p>‚ùå Waktu ujian telah berakhir.</p>";
  return;
}  
    }
  setInterval(checkStartTime, 1000);

      // tampilkan tombol atau pesan sesuai device
      if (isiOS()) {
        document.getElementById("iosMsg").style.display = "block";
      } else if (isAndroid()) {
        document.getElementById("fullscreenBtn").style.display = "block";
      }
    });

    function checkStartTime() {
      const now = new Date();
      const btn = document.getElementById("startBtn");
      const msg = document.getElementById("startMsg");

      if (now < soalStart) {
        btn.disabled = true;
        const sisa = Math.floor((soalStart - now) / 1000);
        msg.innerText = `‚è≥ Mulai dalam ${Math.floor(sisa/60)} menit ${sisa%60} detik`;
      } else if (now >= soalStart && now <= soalEnd) {
        btn.disabled = false;
        msg.innerText = "‚úÖ Ujian bisa dimulai!";
      } else {
        btn.disabled = true;
        msg.innerText = "‚ùå Waktu ujian sudah berakhir.";
      }
    }

    window.startExam = async function() {
  if (isAndroid()) startFullscreen();

  // kalau examStartTime sudah ada (login ulang), jangan direset
  if (!examStartTime) {
    examStartTime = new Date();
  }

  const user = auth.currentUser;
  if (user) {
    await setDoc(doc(db, "jawaban", user.uid), {
      started: true,
      startedAt: examStartTime,   // ‚¨ÖÔ∏è simpan waktu mulai ke Firestore
      lastActivity: new Date(),
      submitted: false
    }, { merge: true });
  }

  document.getElementById("startSection").style.display = "none";
  document.getElementById("examSection").style.display = "block";
  renderQuestion();
  renderNav();
  startTimer();

  // üîπ UNLOCK AUDIO
const audio = document.getElementById("alertSound");
audio.play().then(() => {
  audio.pause();
  audio.currentTime = 0;
}).catch(()=>{});
    }
      
    function startTimer() {
      timerInterval = setInterval(() => {
        const now = new Date();
        const sisa = soalEnd - now;
        if (sisa <= 0) {
          clearInterval(timerInterval);
          document.getElementById("timer").innerText = "00:00";
          alert("‚è∞ Waktu habis! Logout otomatis.");
          logout();
        } else {
          const m = Math.floor((sisa / 1000 / 60) % 60);
          const h = Math.floor((sisa / 1000 / 60 / 60));
          const s = Math.floor((sisa / 1000) % 60);
          document.getElementById("timer").innerText =
            (h>0 ? h+":" : "") + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
        }
        updateSubmitBtnState();
      }, 1000);
    }

    function renderQuestion() {
      if (soalData.length === 0) return;
      document.getElementById("question").innerText = soalData[current].Pertanyaan;
      const optsDiv = document.getElementById("opts");
      optsDiv.innerHTML = "";
      ["A","B","C","D","E"].forEach(opt => {
  const btn = document.createElement("button");
  btn.innerText = opt + ". " + (soalData[current][opt] || "");

  // jika tipe soal multiple, cek array
  if (soalData[current].tipe === "multiple") {
    if (answers[current] && answers[current].includes(opt)) {
      btn.classList.add("selected");
    }
    btn.onclick = () => toggleOption(opt); // bukan selectOption tunggal
  } else {
    // single choice seperti biasa
    if (answers[current] === opt) btn.classList.add("selected");
    btn.onclick = () => selectOption(opt);
  }

  optsDiv.appendChild(btn);
});

      // üîπ Update tombol prev/next sesuai posisi soal
  document.getElementById("prevBtn").disabled = current === 0;
  document.getElementById("nextBtn").disabled = current === soalData.length - 1;
    }
    window.prevQuestion = function() {
  if (current > 0) {
    current--;
    renderQuestion();
  }
};

window.nextQuestion = function() {
  if (current < soalData.length - 1) {
    current++;
    renderQuestion();
  }
};
    

    function selectOption(opt) {
      answers[current] = opt;
      renderQuestion();
      renderNav();
      saveAnswer();
      checkAllAnswered();
    }
    function toggleOption(opt) {
  if (!answers[current]) answers[current] = [];
  const idx = answers[current].indexOf(opt);
  if (idx === -1) {
    answers[current].push(opt);
  } else {
    answers[current].splice(idx, 1);
  }
  renderQuestion();
  renderNav();
  saveAnswer();
  checkAllAnswered();
    }

    // üîπ Fungsi bantu untuk update warna nav soal
function updateNavButtonColor(index, answered) {
  const navBtn = document.querySelector(`#navQ button[data-index="${index}"]`);
  if (navBtn) {
    if (answered) {
      navBtn.classList.add("done");
    } else {
      navBtn.classList.remove("done");
    }
  }
    }
    
    function renderNav() {
      const nav = document.getElementById("navQ");
      nav.innerHTML = "";
      soalData.forEach((_, i) => {
        const btn = document.createElement("button");
        btn.innerText = i+1;
        if (answers[i]) btn.classList.add("done");
        btn.onclick = () => { current = i; renderQuestion(); };
        nav.appendChild(btn);
      });
      checkAllAnswered();
    }

    function checkAllAnswered() {
      if (Object.keys(answers).length === soalData.length) {
        document.getElementById("submitBtn").style.display = "block";
        updateSubmitBtnState();
      }
    }
    function updateSubmitBtnState() {
  const submitBtn = document.getElementById("submitBtn");
  if (!soalStart || !soalEnd || !examStartTime) return; // ambil jadwal dari guru

  const now = new Date();

  // menit sejak guru start
  const elapsedMinutes = Math.floor((now - examStartTime) / 60000);

  // sisa waktu ujian
  const remainingMinutes = Math.floor((soalEnd - now) / 60000);

  if (elapsedMinutes >= soalMinSubmit && remainingMinutes > 0) {
    // tombol aktif
    submitBtn.disabled = false;
    submitBtn.innerText = "Kirim Jawaban";
  } else if (remainingMinutes <= 0) {
    // kalau waktu habis
    submitBtn.disabled = true;
    submitBtn.innerText = "Waktu Habis";
  } else {
    // countdown sampai aktif
    const sisa = soalMinSubmit - elapsedMinutes;
    submitBtn.disabled = true;
    submitBtn.innerText = `Kirim Jawaban (aktif ${sisa} menit lagi)`;
  }
    }

    async function saveAnswer() {
      const user = auth.currentUser;
      if (!user) return;
      await setDoc(doc(db, "jawaban", user.uid), {
        answers,
        lastActivity: new Date(),
        started: true
      }, { merge: true });
    }
    // ============================
// üíØ Fungsi Penilaian Jawaban
// ============================
function hitungSkor() {
  let skor = 0;
  soalData.forEach((soal, i) => {
    const kunci = soal.jawabanBenar; // string atau array
    const jawaban = answers[i];

    if (soal.tipe === "multiple") {
      // Jika soal multiple, cocokkan array jawaban
      if (Array.isArray(jawaban) && Array.isArray(kunci)) {
        if (arraySama(jawaban.sort(), kunci.sort())) {
          skor++;
        }
      }
    } else {
      // Jika soal single
      if (jawaban === kunci) {
        skor++;
      }
    }
  });
  return skor;
}

function arraySama(a, b) {
  return a.length === b.length && a.every((v, i) => v === b[i]);
    }
    window.submitExam = async function() {
  document.getElementById("submitBtn").disabled = true;
  document.getElementById("submitMsg").innerText = "‚úÖ Jawaban berhasil dikirim!";
  clearInterval(timerInterval);

  const user = auth.currentUser;
  if (user) {
    // üíØ Hitung skor sebelum simpan
    const skorAkhir = hitungSkor();

    await setDoc(doc(db, "jawaban", user.uid), {
      submitted: true,
      finishedAt: new Date(),
      lastActivity: new Date(),
      skor: skorAkhir
    }, { merge: true });
  }

  logout();
};
    
    window.logout = async function() {
      await signOut(auth);
      window.location.href = "index.html";
    };

    async function logCheating(reason) {
      const user = auth.currentUser;
      if (!user) return;
      await addDoc(collection(db, "cheatingLogs"), { uid: user.uid, reason, time: new Date() });
    }

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) logCheating("Pindah tab/minimize");
    });
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("copy", e => e.preventDefault());
    document.addEventListener("cut", e => e.preventDefault());
    document.addEventListener("paste", e => e.preventDefault());
  </script>
</body>
  </html>
