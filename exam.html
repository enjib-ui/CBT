<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Halaman Ujian</title>
</head>
<body>
  <h2>üìò Ujian Online</h2>
  <div id="navSoal"></div>
  <div id="soalContainer">Menunggu soal...</div>
  <button onclick="prevSoal()">‚¨ÖÔ∏è Sebelumnya</button>
  <button onclick="nextSoal()">‚û°Ô∏è Selanjutnya</button>
  <button onclick="submitJawaban()">‚úÖ Kirim Jawaban</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDonmsxOpPSafblXFwjZozjQjb6d_ONDG8",
  authDomain: "authfirebase-4a2ce.firebaseapp.com",
  projectId: "authfirebase-4a2ce",
  storageBucket: "authfirebase-4a2ce.firebasestorage.app",
  messagingSenderId: "395028121712",
  appId: "1:395028121712:web:8bf3d5470c13204bef8cb5"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let semuaSoal = [];
    let jawabanSiswa = {};
    let currentIndex = 0;

    const soalContainer = document.getElementById("soalContainer");
    const navSoal = document.getElementById("navSoal");

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          const { kelas, mapel } = userDoc.data();
          const soalRef = doc(db, "soal", kelas, mapel);
          onSnapshot(soalRef, (snap) => {
            if (snap.exists()) {
              semuaSoal = snap.data().soal;
              tampilkanSoal(0);
            } else {
              soalContainer.innerHTML = "‚ùå Soal tidak ditemukan.";
            }
          });
        }
      } else {
        window.location.href = "index.html";
      }
    });

    function tampilkanSoal(i) {
      currentIndex = i;
      const row = semuaSoal[i]; if (!row) return;
      const opsi = ["A","B","C","D","E"];
      let opsiHTML = "";
      opsi.forEach(o => { if (row[o]) { opsiHTML += `<label><input type="radio" name="soal${i}" value="${o}">${o}. ${row[o]}</label><br>`; } });
      soalContainer.innerHTML = `<p><b>${i+1}.</b> ${row.Pertanyaan}</p>${opsiHTML}`;
    }

    function simpanJawaban() {
      const selected = document.querySelector("input[name=soal"+currentIndex+"]:checked");
      if (selected) jawabanSiswa["soal"+currentIndex] = selected.value;
    }

    window.nextSoal = function() { simpanJawaban(); if (currentIndex < semuaSoal.length-1) tampilkanSoal(currentIndex+1); };
    window.prevSoal = function() { simpanJawaban(); if (currentIndex > 0) tampilkanSoal(currentIndex-1); };
    window.submitJawaban = async function() {
      simpanJawaban();
      try { await addDoc(collection(db, "jawaban"), { jawaban: jawabanSiswa, waktu: serverTimestamp() }); alert("‚úÖ Jawaban tersimpan!"); } 
      catch (err) { alert("‚ùå Gagal simpan: "+err.message); }
    };
  </script>
</body>
</html>
